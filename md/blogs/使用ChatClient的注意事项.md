# 使用ChatClient的注意事项
野火IM客户端是分层的，可见的最下层就是ChatClient（在Android/iOS/PC/Web 上都有对应的模块，名字稍微有区别），这个模块包含了野火IM的所有功能实现，但不包括任何的UI。我们提供了UI层使用ChatClient功能，提供给客户可以开箱即用的IM能力。但会有些客户无法直接使用UI层，需要基于ChatClient自己来开发UI。遇到最大的一个问题就是性能问题，因为ChatClient有很多特性，需要弄清楚才能避免性能问题。

1. 获取用户/群组/频道等信息时触发网络同步
野火IM协议栈有个逻辑是，当上层获取用户/群组/频道信息时，如果本地没有缓存，则去服务器更新。这样如果在本地没有对应信息时，如果快速的获取10次用户信息，那么协议栈将会去服务器请求10次，这个代价将会是非常大的。因此需要避免多次无效更新。

2. UserSetting更新
有很多信息都跟用户设置有关，比如会话静音置顶等，比如群组收藏，比如星标好友等。因为用户设置更新没有区别是那一类设置更新了，所以当收到用户设置更新时，需要刷新UI。

## 问题产生的原因
一个常见的常见就是用户收到大量的消息，比如用户首次登录或者很长时间没有登录了。如果UI层是一条消息一条消息处理，每一条消息刷新一遍，没刷新一遍就会获取一下用户信息（如果有就没有压力，如果没有就会产生一下网络同步请求），这样会对UI和协议栈产生巨大的压力。还有就是新用户或其它信息收到后，会有更新通知，如果每个更新通知都刷一遍的话，也会有问题。

## 问题解决办法
ChatClient层收到消息是批量接收的，UI层要批量处理，不能每条刷新一次。另外连接状态都是连接中，接收中，已连接这个模式，可以***在连接状态在接收中时不刷新UI，在连接状态变为已连接的时候刷新一遍UI***。当收到用户信息或其它信息更新时，仅刷新有变化的部分，不要全部刷新。目标是尽量减少当用户信息或其它信息本地不存在时去获取的次数。
